#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define MAX_BOOKS 1000
#define TITLE_SIZE 100
#define AUTHOR_SIZE 100
#define DATA_FILE "library.dat"

typedef struct {
    int id;
    char title[TITLE_SIZE];
    char author[AUTHOR_SIZE];
    int totalCopies;
    int availableCopies;
} Book;

Book books[MAX_BOOKS];
int bookCount = 0;

// ---------- Function Declarations ----------
void loadData();
void saveData();
void addBook();
void listBooks();
void searchBookById();
void searchBookByTitle();
void issueBook();
void returnBook();
void clearInputBuffer();

// ---------- Main Function ----------
int main() {
    int choice;

    loadData(); // Load saved books from file (if exists)

    while (1) {
        printf("\n===== LIBRARY MANAGEMENT SYSTEM =====\n");
        printf("1. Add Book\n");
        printf("2. List All Books\n");
        printf("3. Search Book by ID\n");
        printf("4. Search Book by Title\n");
        printf("5. Issue (Borrow) Book\n");
        printf("6. Return Book\n");
        printf("7. Save & Exit\n");
        printf("Enter your choice: ");
        if (scanf("%d", &choice) != 1) {
            printf("Invalid input! Please enter a number.\n");
            clearInputBuffer();
            continue;
        }

        clearInputBuffer(); // Clear newline left in buffer

        switch (choice) {
            case 1:
                addBook();
                break;
            case 2:
                listBooks();
                break;
            case 3:
                searchBookById();
                break;
            case 4:
                searchBookByTitle();
                break;
            case 5:
                issueBook();
                break;
            case 6:
                returnBook();
                break;
            case 7:
                saveData();
                printf("Data saved. Exiting program.\n");
                exit(0);
            default:
                printf("Invalid choice! Please select from the menu.\n");
        }
    }

    return 0;
}

// ---------- Utility: Clear Input Buffer ----------
void clearInputBuffer() {
    int c;
    while ((c = getchar()) != '\n' && c != EOF) {
        // discard
    }
}

// ---------- Load Data From File ----------
void loadData() {
    FILE *fp = fopen(DATA_FILE, "rb");
    if (fp == NULL) {
        // File does not exist, first run
        printf("No existing data found. Starting new library.\n");
        return;
    }

    if (fread(&bookCount, sizeof(int), 1, fp) != 1) {
        printf("Error reading data file.\n");
        fclose(fp);
        return;
    }

    if (bookCount > 0 && bookCount <= MAX_BOOKS) {
        if (fread(books, sizeof(Book), bookCount, fp) != (size_t)bookCount) {
            printf("Error reading book records.\n");
        }
    } else if (bookCount < 0 || bookCount > MAX_BOOKS) {
        printf("Data file is corrupted or invalid book count.\n");
        bookCount = 0;
    }

    fclose(fp);
    printf("%d book(s) loaded from file.\n", bookCount);
}

// ---------- Save Data To File ----------
void saveData() {
    FILE *fp = fopen(DATA_FILE, "wb");
    if (fp == NULL) {
        printf("Error opening file for writing.\n");
        return;
    }

    if (fwrite(&bookCount, sizeof(int), 1, fp) != 1) {
        printf("Error writing book count.\n");
        fclose(fp);
        return;
    }

    if (bookCount > 0) {
        if (fwrite(books, sizeof(Book), bookCount, fp) != (size_t)bookCount) {
            printf("Error writing book records.\n");
        }
    }

    fclose(fp);
}

// ---------- Add New Book ----------
void addBook() {
    if (bookCount >= MAX_BOOKS) {
        printf("Library is full! Cannot add more books.\n");
        return;
    }

    Book b;

    printf("Enter Book ID (integer): ");
    if (scanf("%d", &b.id) != 1) {
        printf("Invalid ID.\n");
        clearInputBuffer();
        return;
    }
    clearInputBuffer(); // remove leftover newline

    // Check if ID already exists
    for (int i = 0; i < bookCount; i++) {
        if (books[i].id == b.id) {
            printf("A book with this ID already exists!\n");
            return;
        }
    }

    printf("Enter Book Title: ");
    fgets(b.title, TITLE_SIZE, stdin);
    b.title[strcspn(b.title, "\n")] = '\0'; // remove newline

    printf("Enter Author Name: ");
    fgets(b.author, AUTHOR_SIZE, stdin);
    b.author[strcspn(b.author, "\n")] = '\0'; // remove newline

    printf("Enter Total Copies: ");
    if (scanf("%d", &b.totalCopies) != 1 || b.totalCopies < 1) {
        printf("Invalid number of copies.\n");
        clearInputBuffer();
        return;
    }

    b.availableCopies = b.totalCopies;

    books[bookCount] = b;
    bookCount++;

    printf("Book added successfully!\n");
}

// ---------- List All Books ----------
void listBooks() {
    if (bookCount == 0) {
        printf("No books in the library.\n");
        return;
    }

    printf("\n----- List of Books -----\n");
    printf("%-5s | %-30s | %-20s | %-10s | %-10s\n",
           "ID", "Title", "Author", "Total", "Available");
    printf("-------------------------------------------------------------------------------\n");

    for (int i = 0; i < bookCount; i++) {
        printf("%-5d | %-30s | %-20s | %-10d | %-10d\n",
               books[i].id,
               books[i].title,
               books[i].author,
               books[i].totalCopies,
               books[i].availableCopies);
    }
}

// ---------- Search Book by ID ----------
void searchBookById() {
    if (bookCount == 0) {
        printf("No books in the library.\n");
        return;
    }

    int id;
    printf("Enter Book ID to search: ");
    if (scanf("%d", &id) != 1) {
        printf("Invalid ID.\n");
        clearInputBuffer();
        return;
    }

    for (int i = 0; i < bookCount; i++) {
        if (books[i].id == id) {
            printf("\nBook Found:\n");
            printf("ID: %d\n", books[i].id);
            printf("Title: %s\n", books[i].title);
            printf("Author: %s\n", books[i].author);
            printf("Total Copies: %d\n", books[i].totalCopies);
            printf("Available Copies: %d\n", books[i].availableCopies);
            return;
        }
    }

    printf("No book found with ID %d.\n", id);
}

// ---------- Search Book by Title (partial match) ----------
void searchBookByTitle() {
    if (bookCount == 0) {
        printf("No books in the library.\n");
        return;
    }

    char title[TITLE_SIZE];
    printf("Enter Book Title (or part of it) to search: ");
    fgets(title, TITLE_SIZE, stdin);
    title[strcspn(title, "\n")] = '\0'; // remove newline

    int found = 0;
    for (int i = 0; i < bookCount; i++) {
        if (strstr(books[i].title, title) != NULL) { // partial match
            if (!found) {
                printf("\nBooks matching \"%s\":\n", title);
                printf("%-5s | %-30s | %-20s | %-10s | %-10s\n",
                       "ID", "Title", "Author", "Total", "Available");
                printf("-------------------------------------------------------------------------------\n");
            }

            printf("%-5d | %-30s | %-20s | %-10d | %-10d\n",
                   books[i].id,
                   books[i].title,
                   books[i].author,
                   books[i].totalCopies,
                   books[i].availableCopies);

            found = 1;
        }
    }

    if (!found) {
        printf("No books found with title containing \"%s\".\n", title);
    }
}

// ---------- Issue (Borrow) Book ----------
void issueBook() {
    if (bookCount == 0) {
        printf("No books in the library.\n");
        return;
    }

    int id;
    printf("Enter Book ID to issue: ");
    if (scanf("%d", &id) != 1) {
        printf("Invalid ID.\n");
        clearInputBuffer();
        return;
    }

    for (int i = 0; i < bookCount; i++) {
        if (books[i].id == id) {
            if (books[i].availableCopies > 0) {
                books[i].availableCopies--;
                printf("Book issued successfully! Remaining available copies: %d\n",
                       books[i].availableCopies);
            } else {
                printf("No copies available to issue.\n");
            }
            return;
        }
    }

    printf("No book found with ID %d.\n", id);
}

// ---------- Return Book ----------
void returnBook() {
    if (bookCount == 0) {
        printf("No books in the library.\n");
        return;
    }

    int id;
    printf("Enter Book ID to return: ");
    if (scanf("%d", &id) != 1) {
        printf("Invalid ID.\n");
        clearInputBuffer();
        return;
    }

    for (int i = 0; i < bookCount; i++) {
        if (books[i].id == id) {
            if (books[i].availableCopies < books[i].totalCopies) {
                books[i].availableCopies++;
                printf("Book returned successfully! Available copies: %d\n",
                       books[i].availableCopies);
            } else {
                printf("All copies are already in the library. Cannot return more.\n");
            }
            return;
        }
    }

    printf("No book found with ID %d.\n", id);
}